#!/usr/bin/env bash

#  http://github.com/thewoolleyman/boxbuilder
#  Copyright (c) 2010 Chad Woolley - The MIT License

export PS4='+(${BASH_SOURCE}:${LINENO}): ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'

set -o errexit
set -o noclobber
set -o nounset
set -o pipefail
set â€“o verbose
set -o xtrace

handle_error() {
  echo "BOXBUILDER - boxbuilder_remote_bootstrap: error on line $LINENO"
  exit 1 # TODO: return original error code.  how?
}

trap handle_error ERR EXIT INT TERM

exec_remotely() {
  local arg_array i rc
  for arg; do
    arg_array[i++]=$(printf %q "$arg")
  done
  echo "ssh -i $boxbuilder_keypair $boxbuilder_user@$boxbuilder_host \"$@\""
  ssh -i $boxbuilder_keypair $boxbuilder_user@$boxbuilder_host "$@"
}

exec_remotely_quiet() {
  local arg_array i rc
  for arg; do
    arg_array[i++]=$(printf %q "$arg")
  done
  # echo "ssh -i $boxbuilder_keypair $boxbuilder_user@$boxbuilder_host \"$@\""
  ssh -i $boxbuilder_keypair $boxbuilder_user@$boxbuilder_host "$@"
}

exec_remotely_pseudo_tty() {
  local arg_array i rc
  for arg; do
    arg_array[i++]=$(printf %q "$arg")
  done
  echo "ssh -t -i $boxbuilder_keypair $boxbuilder_user@$boxbuilder_host \"$@\""
  ssh -t -i $boxbuilder_keypair $boxbuilder_user@$boxbuilder_host "$@"
}

setup() {
  echo "BOXBUILDER - boxbuilder_remote_bootstrap:  Environment variable setup ..."
  if [ -e $HOME/.boxbuilderrc ]; then
    . $HOME/.boxbuilderrc
  fi
  boxbuilder_config=${boxbuilder_config:-'export boxbuilder_config_placeholder_from_boxbuilder_remote_bootstrap=boxbuilder_config_placeholder_from_boxbuilder_remote_bootstrap'}
  eval $boxbuilder_config
  boxbuilder_keypair=${boxbuilder_keypair:?"Please set 'boxbuilder_keypair' to the path of your ssh private key file"}
  boxbuilder_user=${boxbuilder_user:?"Please set 'boxbuilder_user' to the ssh user on the box being built"}
  boxbuilder_host=${boxbuilder_host:?"Please set 'boxbuilder_host' to the hostname or IP of the box being built"}
  boxbuilder_bootstrap_url=${boxbuilder_bootstrap_url:-"http://github.com/thewoolleyman/boxbuilder/raw/master/boxbuilder_bootstrap"}

  echo "BOXBUILDER - boxbuilder_remote_bootstrap:  Finished environment variable setup:"
  echo "boxbuilder_config=$boxbuilder_config"
  # TODO: Add all env vars which are directly used by this script
}

remote_bootstrap() {
  _boxbuilder_bootstrap_script=/tmp/${boxbuilder_bootstrap_url##*/} # grabs last path component of url to use as script name
  echo "BOXBUILDER - boxbuilder_remote_bootstrap: Downloading $boxbuilder_bootstrap_url to $_boxbuilder_bootstrap_script on $boxbuilder_host ..."
  exec_remotely "wget -O $_boxbuilder_bootstrap_script $boxbuilder_bootstrap_url"
  while exists=$(exec_remotely_quiet "if [[ -e $_boxbuilder_bootstrap_script ]] ; then echo exists; fi"); test "$exists" != "exists" ; do
    echo "BOXBUILDER - boxbuilder_remote_bootstrap: Waiting for wget to finish downloading $boxbuilder_bootstrap_url to $_boxbuilder_bootstrap_script on $boxbuilder_host ..."
    sleep 3
  done
  echo "BOXBUILDER - boxbuilder_remote_bootstrap: $boxbuilder_bootstrap_url successfully downloaded to $_boxbuilder_bootstrap_script on $boxbuilder_host ..."

  echo "BOXBUILDER - boxbuilder_remote_bootstrap: Changing permissions on $_boxbuilder_bootstrap_script on $boxbuilder_host ..."
  exec_remotely "chmod a+x $_boxbuilder_bootstrap_script"
  echo "BOXBUILDER - boxbuilder_remote_bootstrap: Running $_boxbuilder_bootstrap_script on $boxbuilder_host ..."
  exec_remotely_pseudo_tty "$boxbuilder_config && $_boxbuilder_bootstrap_script"
}

run() {
  setup
  remote_bootstrap
}

run