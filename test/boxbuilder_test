#!/usr/bin/env bash

#  http://github.com/thewoolleyman/boxbuilder
#  Copyright (c) 2010 Chad Woolley - The MIT License

set -o noclobber
set -e
set -o pipefail
set -o nounset
trap 'echo BOXBUILDER: boxbuilder_test: error on line $LINENO' ERR

exec_remotely_quiet() {
  local arg_array i rc
  for arg; do
    arg_array[i++]=$(printf %q "$arg")
  done
  ssh -i $boxbuilder_keypair $boxbuilder_user@$boxbuilder_host "$@"
}

setup() {
  . `dirname $0`/test_helper
  . $HOME/.boxbuilderrc
  boxbuilder_keypair=${boxbuilder_keypair:?Please set 'boxbuilder_keypair' to the path of your ssh private key file}
  boxbuilder_user=${boxbuilder_user:?Please set 'boxbuilder_user' to the ssh user on the box you are using to test}
  boxbuilder_host=${boxbuilder_host:?Please set 'boxbuilder_host' to the hostname or IP of the box you are using to test}
}

test_can_log_in_as_user() {
  remote_user=$(exec_remotely_quiet "whoami")
  assert_equal $boxbuilder_user $remote_user
}

test_can_download_boxbuilder_bootstrap() {
  `dirname $0`/../boxbuilder_remote_bootstrap
  expected_path=$(exec_remotely_quiet "which /tmp/boxbuilder_bootstrap")
  assert_equal '/tmp/boxbuilder_bootstrap' $expected_path
}

test_can_install_rvm() {
  `dirname $0`/../boxbuilder_remote_bootstrap
  rvm_info=$(exec_remotely_quiet "rvm info | head -n 1")
  assert_match 'ruby' $rvm_info
}

suite() {
  setup
  test_can_log_in_as_user
  test_can_download_boxbuilder_bootstrap
  test_can_install_rvm
  echo "All tests completed"
}

suite