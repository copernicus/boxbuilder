#!/usr/bin/env bash

#  http://github.com/thewoolleyman/boxbuilder
#  Copyright (c) 2010 Chad Woolley - The MIT License

export PS4='+(${BASH_SOURCE}:${LINENO}): ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'

set -o errexit
set -o errtrace
set -o noclobber
set -o nounset
set -o pipefail
set â€“o verbose
set -o xtrace

function onexit() {
  local exit_status=${1:-$?}
  if [[ $exit_status != 0 ]]; then
    _error_line="error on line $LINENO."
  else
    _error_line=''
  fi
  echo "BOXBUILDER - boxbuilder_test: $_error_line Exiting $0 with $exit_status"
  exit $exit_status
}

trap onexit HUP INT QUIT TERM ERR

exec_remotely_quiet() {
  local arg_array i rc
  for arg; do
    arg_array[i++]=$(printf %q "$arg")
  done
  ssh -i $boxbuilder_keypair $boxbuilder_user@$boxbuilder_host "$@"
}

setup() {
  . `dirname $0`/test_helper
  . $HOME/.boxbuilderrc
  boxbuilder_keypair=${boxbuilder_keypair:?Please set 'boxbuilder_keypair' to the path of your ssh private key file}
  boxbuilder_user=${boxbuilder_user:?Please set 'boxbuilder_user' to the ssh user on the box you are using to test}
  boxbuilder_host=${boxbuilder_host:?Please set 'boxbuilder_host' to the hostname or IP of the box you are using to test}
  `dirname $0`/../boxbuilder_remote_bootstrap
}

test_can_log_in_as_user() {
  remote_user=$(exec_remotely_quiet "whoami")
  assert_equal $boxbuilder_user $remote_user
}

test_can_download_boxbuilder_bootstrap() {
  expected_path=$(exec_remotely_quiet "which /tmp/boxbuilder_bootstrap")
  assert_equal '/tmp/boxbuilder_bootstrap' $expected_path
}

test_can_install_rvm() {
  rvm_info=$(exec_remotely_quiet "rvm info | head -n 1")
  assert_match 'ruby' $rvm_info
}

test_can_set_up_and_run_chef() {
  example1_touchfile_contents=$(exec_remotely_quiet 'cat $HOME/.tmp_boxbuilder_example1_chef_cookbook.touchfile')
  assert_equal 'boxbuilder_example1_chef_config_value' $example1_touchfile_contents
  example2_touchfile_contents=$(exec_remotely_quiet 'cat $HOME/.tmp_boxbuilder_example2_chef_cookbook.touchfile')
  assert_match 'boxbuilder_example2_chef_config_value' $example2_touchfile_contents
}

suite() {
  echo "BOXBUILDER - boxbuilder_test: Starting tests ..."
  setup
  test_can_log_in_as_user
  test_can_download_boxbuilder_bootstrap
  test_can_install_rvm
  test_can_set_up_and_run_chef
  echo "BOXBUILDER - boxbuilder_test: All tests passed successfully"
}

suite
onexit